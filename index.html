<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chickens vs Subscribers</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <div class="container">
      <h1>Chickens vs Subscribers</h1>

      <div class="card row controls">
        <div>
          <b>Labels:</b>
          <label>
            <input type="checkbox" id="showDelta" />
            Show Δ (difference)
          </label>
          <label>
            <input type="checkbox" id="showMult" />
            Show × (multiplier)
          </label>
          <label>
            <input type="checkbox" id="showLegend" checked />
            Show legend (key)
          </label>
        </div>
      </div>

      <div class="card chart-container">
        <canvas id="chart"></canvas>
        <p id="stats" class="muted"></p>
      </div>
    </div>

    <script>
      const statsEl = document.getElementById("stats");

      const showDeltaEl = document.getElementById("showDelta");
      const showMultEl = document.getElementById("showMult");
      const showLegendEl = document.getElementById("showLegend");

      let chart = null;
      let rows = [];

      function splitCSVLine(line) {
        const result = [];
        let cur = "";
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
          const ch = line[i];

          if (ch === '"') {
            if (inQuotes && line[i + 1] === '"') {
              cur += '"';
              i++;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (ch === "," && !inQuotes) {
            result.push(cur);
            cur = "";
          } else {
            cur += ch;
          }
        }
        result.push(cur);
        return result.map(s => s.trim());
      }

      function parseCSV(text) {
        const lines = text.replace(/\r/g, "").trim().split("\n");
        if (lines.length < 2) return [];

        const headers = lines[0].split(",").map(h => h.trim());
        const out = [];

        for (let i = 1; i < lines.length; i++) {
          const parts = splitCSVLine(lines[i]);
          if (parts.length !== headers.length) continue;

          const row = {};
          headers.forEach((h, j) => (row[h] = parts[j]));

          ["day", "subscribers", "chickens"].forEach(k => {
            if (row[k] !== undefined && row[k] !== "") {
              const n = Number(row[k]);
              row[k] = Number.isFinite(n) ? n : row[k];
            }
          });

          out.push(row);
        }
        return out;
      }

      function fmtDelta(n) {
        if (!Number.isFinite(n)) return "";
        const sign = n > 0 ? "+" : "";
        return sign + n.toLocaleString();
      }

      function fmtMult(a, b) {
        if (!Number.isFinite(a) || !Number.isFinite(b) || a === 0) return "";
        const r = b / a;
        if (!Number.isFinite(r) || r <= 0) return "";
        if (Math.abs(r - Math.round(r)) < 1e-10) return `${Math.round(r)}x`;
        if (r >= 10) return `${r.toFixed(1)}x`;
        return `${r.toFixed(2)}x`;
      }

      const segmentLabelsPlugin = {
        id: "segmentLabelsPlugin",
        afterDatasetsDraw(chart, args, pluginOptions) {
          const { ctx } = chart;
          const showDelta = !!pluginOptions.showDelta;
          const showMult = !!pluginOptions.showMult;

          if (!showDelta && !showMult) return;

          ctx.save();
          ctx.font = "12px system-ui, Arial, sans-serif";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";

          for (let di = 0; di < chart.data.datasets.length; di++) {
            const meta = chart.getDatasetMeta(di);
            if (!meta || meta.hidden) continue;

            const ds = chart.data.datasets[di];
            const data = ds.data;

            // Offset label direction so 2 series are readable
            const offsetY = di % 2 === 0 ? -14 : 14;

            for (let i = 1; i < data.length; i++) {
              const p0 = meta.data[i - 1];
              const p1 = meta.data[i];
              if (!p0 || !p1) continue;

              const v0 = data[i - 1]?.y;
              const v1 = data[i]?.y;
              if (!Number.isFinite(v0) || !Number.isFinite(v1)) continue;

              const x0 = p0.x, y0 = p0.y;
              const x1 = p1.x, y1 = p1.y;

              if (showMult) {
                const mx = (x0 + x1) / 2;
                const my = (y0 + y1) / 2 + offsetY;

                const txt = fmtMult(v0, v1);
                if (txt) {
                  ctx.fillStyle = "#111";
                  ctx.fillText(txt, mx, my);
                }
              }

              if (showDelta) {
                const dx = x1;
                const dy = y1 + offsetY;

                const txt = fmtDelta(v1 - v0);
                if (txt) {
                  ctx.fillStyle = "#111";
                  ctx.fillText(txt, dx, dy);
                }
              }
            }
          }

          ctx.restore();
        }
      };

      function render() {
        if (!rows.length) return;

        const chickens = rows
          .map(r => {
            const x = Number(r.day);
            const y = Number(r.chickens);
            return { x, y };
          })
          .filter(p => p.x !== "" && p.x != null && Number.isFinite(p.y));

        const subs = rows
          .map(r => {
            const x = Number(r.day);
            const y = Number(r.subscribers);
            return { x, y };
          })
          .filter(p => p.x !== "" && p.x != null && Number.isFinite(p.y));

        const cfg = {
          type: "line",
          data: {
            datasets: [
              {
                label: "Chickens",
                data: chickens,
                tension: 0.2,
                pointRadius: 3,
                borderColor: "#ff6384",
                backgroundColor: "rgba(255, 99, 132, 0.2)",
              },
              {
                label: "Subscribers",
                data: subs,
                tension: 0.2,
                pointRadius: 3,
                borderColor: "#36a2eb",
                backgroundColor: "rgba(54, 162, 235, 0.2)",
              },
            ],
          },
          options: {
            parsing: false,
            responsive: true,
            interaction: { mode: "nearest", intersect: false },
            plugins: {
              legend: { display: showLegendEl.checked, position: "right" },
              segmentLabelsPlugin: { showDelta: showDeltaEl.checked, showMult: showMultEl.checked },
            },
            scales: {
              x: { type: "linear", title: { display: true, text: "Day" } },
              y: {
                type: "linear",
                title: { display: true, text: "Amount" },
              },
            },
          },
          plugins: [segmentLabelsPlugin],
        };

        if (chart) chart.destroy();
        chart = new Chart(document.getElementById("chart"), cfg);

        const missingSubs = rows.filter(r => r.subscribers === null || r.subscribers === "" || r.subscribers === undefined).length;
        const missingChick = rows.filter(r => r.chickens === null || r.chickens === "" || r.chickens === undefined).length;
        statsEl.textContent = `Rows loaded: ${rows.length} • Missing subscribers: ${missingSubs} • Missing chickens: ${missingChick}`;
      }

      async function loadRepoCSV() {
        const res = await fetch("./youtube_chickens.csv?cb=" + Date.now());
        const text = await res.text();
        rows = parseCSV(text);

        // Force sort by day (just in case)
        rows.sort((a, b) => Number(a.day) - Number(b.day));

        render();
      }

      [showDeltaEl, showMultEl, showLegendEl].forEach(el =>
        el.addEventListener("change", render)
      );

      // Auto-load on page open
      loadRepoCSV().catch(err => {
        statsEl.textContent = "Could not load youtube_chickens.csv from repo yet.";
        console.error(err);
      });
    </script>
  </body>
</html>